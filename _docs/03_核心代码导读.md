# Open-AutoGLM æ ¸å¿ƒä»£ç å¯¼è¯»

## ğŸ“ é¡¹ç›®ç»“æ„

```
Open-AutoGLM/
â”œâ”€â”€ phone_agent/           # æ ¸å¿ƒåŒ…
â”‚   â”œâ”€â”€ __init__.py        # åŒ…å¯¼å‡º
â”‚   â”œâ”€â”€ agent.py           # â­ Agent ä¸»ç±»
â”‚   â”œâ”€â”€ model/             # æ¨¡å‹äº¤äº’
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ client.py      # â­ æ¨¡å‹å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ actions/           # åŠ¨ä½œæ‰§è¡Œ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ handler.py     # â­ åŠ¨ä½œå¤„ç†å™¨
â”‚   â”œâ”€â”€ adb/               # ADB å·¥å…·
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ connection.py  # â­ è¿æ¥ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ device.py      # â­ è®¾å¤‡æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ input.py       # æ–‡æœ¬è¾“å…¥
â”‚   â”‚   â””â”€â”€ screenshot.py  # å±å¹•æˆªå›¾
â”‚   â””â”€â”€ config/            # é…ç½®
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ apps.py        # åº”ç”¨æ˜ å°„
â”‚       â””â”€â”€ prompts.py     # â­ ç³»ç»Ÿæç¤ºè¯
â”œâ”€â”€ examples/              # ç¤ºä¾‹ä»£ç 
â”‚   â”œâ”€â”€ basic_usage.py
â”‚   â””â”€â”€ demo_thinking.py
â”œâ”€â”€ main.py                # â­ å‘½ä»¤è¡Œå…¥å£
â”œâ”€â”€ requirements.txt       # ä¾èµ–
â””â”€â”€ setup.py               # å®‰è£…è„šæœ¬
```

**é˜…è¯»é¡ºåºå»ºè®®**:
1. `main.py` - ç†è§£æ•´ä½“æµç¨‹
2. `agent.py` - æ ¸å¿ƒ Agent é€»è¾‘
3. `model/client.py` - æ¨¡å‹äº¤äº’
4. `actions/handler.py` - åŠ¨ä½œæ‰§è¡Œ
5. `adb/*.py` - åº•å±‚æ§åˆ¶
6. `config/prompts.py` - æç¤ºè¯å·¥ç¨‹

---

## ğŸ¯ æ ¸å¿ƒæ–‡ä»¶ 1: agent.py

### æ–‡ä»¶èŒè´£
**PhoneAgent ç±»**: Agent ç³»ç»Ÿçš„å¤§è„‘ï¼Œè´Ÿè´£ä»»åŠ¡è°ƒåº¦å’ŒçŠ¶æ€ç®¡ç†

### å…³é”®ç±»å’Œæ–¹æ³•

#### 1. AgentConfig (é…ç½®ç±»)

```python
@dataclass
class AgentConfig:
    max_steps: int = 100              # æœ€å¤§æ‰§è¡Œæ­¥æ•°
    device_id: str | None = None      # ADB è®¾å¤‡ ID
    system_prompt: str = SYSTEM_PROMPT  # ç³»ç»Ÿæç¤ºè¯
    verbose: bool = True              # è¯¦ç»†è¾“å‡º
```

**ç”¨é€”**: æ§åˆ¶ Agent è¡Œä¸º
**å¯è°ƒæ•´å‚æ•°**:
- `max_steps`: é˜²æ­¢æ— é™å¾ªç¯
- `verbose`: è°ƒè¯•æ—¶è®¾ä¸º True
- `system_prompt`: å¯è‡ªå®šä¹‰æç¤ºè¯

---

#### 2. PhoneAgent.__init__() (åˆå§‹åŒ–)

```python
def __init__(
    self,
    model_config: ModelConfig | None = None,
    agent_config: AgentConfig | None = None,
    confirmation_callback: Callable[[str], bool] | None = None,
    takeover_callback: Callable[[str], None] | None = None,
):
    self.model_config = model_config or ModelConfig()
    self.agent_config = agent_config or AgentConfig()
    
    # åˆ›å»ºæ¨¡å‹å®¢æˆ·ç«¯
    self.model_client = ModelClient(self.model_config)
    
    # åˆ›å»ºåŠ¨ä½œå¤„ç†å™¨
    self.action_handler = ActionHandler(
        device_id=self.agent_config.device_id,
        confirmation_callback=confirmation_callback,
        takeover_callback=takeover_callback,
    )
    
    # åˆå§‹åŒ–çŠ¶æ€
    self._context: list[dict[str, Any]] = []  # å¯¹è¯å†å²
    self._step_count = 0                      # æ­¥æ•°è®¡æ•°
```

**è®¾è®¡äº®ç‚¹**:
- ä¾èµ–æ³¨å…¥æ¨¡å¼: é…ç½®ã€å›è°ƒéƒ½å¯å¤–éƒ¨ä¼ å…¥
- æ¸…æ™°çš„èŒè´£åˆ†ç¦»: Agent ä¸å…³å¿ƒå…·ä½“å¦‚ä½•è°ƒç”¨æ¨¡å‹æˆ–æ‰§è¡ŒåŠ¨ä½œ

---

#### 3. PhoneAgent.run() (æ‰§è¡Œä»»åŠ¡)

```python
def run(self, task: str) -> str:
    """æ‰§è¡Œä¸€ä¸ªå®Œæ•´ä»»åŠ¡"""
    # é‡ç½®çŠ¶æ€
    self._context = []
    self._step_count = 0
    
    # ç¬¬ä¸€æ­¥ï¼šå¸¦ä»»åŠ¡æè¿°
    result = self._execute_step(task, is_first=True)
    if result.finished:
        return result.message or "Task completed"
    
    # å¾ªç¯æ‰§è¡Œ
    while self._step_count < self.agent_config.max_steps:
        result = self._execute_step(is_first=False)
        if result.finished:
            return result.message or "Task completed"
    
    return "Max steps reached"
```

**ä»£ç è§£è¯»**:
1. **çŠ¶æ€æ¸…ç†**: æ¯ä¸ªä»»åŠ¡å¼€å§‹å‰æ¸…ç©ºå†å²
2. **ä¸¤é˜¶æ®µæ‰§è¡Œ**: 
   - ç¬¬ä¸€æ­¥: åŒ…å«ç”¨æˆ·ä»»åŠ¡æè¿°
   - åç»­æ­¥éª¤: åªæä¾›å±å¹•çŠ¶æ€
3. **ç»ˆæ­¢æ¡ä»¶**: å®Œæˆ æˆ– è¾¾åˆ°æœ€å¤§æ­¥æ•°

**å­¦ä¹ ç‚¹**: ç®€æ´çš„æ§åˆ¶æµç¨‹ï¼Œæ˜“äºç†è§£å’Œæ‰©å±•

---

#### 4. PhoneAgent._execute_step() (å•æ­¥æ‰§è¡Œ) â­â­â­

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿæœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼

```python
def _execute_step(
    self, user_prompt: str | None = None, is_first: bool = False
) -> StepResult:
    """æ‰§è¡Œå•æ­¥ Agent å¾ªç¯"""
    self._step_count += 1
    
    # ==================== é˜¶æ®µ 1: æ„ŸçŸ¥ ====================
    # æ•è·å½“å‰å±å¹•çŠ¶æ€
    screenshot = get_screenshot(self.agent_config.device_id)
    current_app = get_current_app(self.agent_config.device_id)
    
    # ==================== é˜¶æ®µ 2: æ„å»ºæ¶ˆæ¯ ====================
    if is_first:
        # ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ç³»ç»Ÿæç¤ºè¯
        self._context.append(
            MessageBuilder.create_system_message(self.agent_config.system_prompt)
        )
        
        # ç”¨æˆ·ä»»åŠ¡ + å±å¹•ä¿¡æ¯
        screen_info = MessageBuilder.build_screen_info(current_app)
        text_content = f"{user_prompt}\n\n{screen_info}"
        
        self._context.append(
            MessageBuilder.create_user_message(
                text=text_content, 
                image_base64=screenshot.base64_data
            )
        )
    else:
        # åç»­æ­¥éª¤ï¼šä»…å±å¹•ä¿¡æ¯
        screen_info = MessageBuilder.build_screen_info(current_app)
        text_content = f"** Screen Info **\n\n{screen_info}"
        
        self._context.append(
            MessageBuilder.create_user_message(
                text=text_content, 
                image_base64=screenshot.base64_data
            )
        )
    
    # ==================== é˜¶æ®µ 3: æ¨ç† ====================
    try:
        response = self.model_client.request(self._context)
    except Exception as e:
        # æ¨¡å‹é”™è¯¯ â†’ è¿”å›å¤±è´¥
        return StepResult(
            success=False, finished=True, 
            action=None, thinking="", 
            message=f"Model error: {e}"
        )
    
    # ==================== é˜¶æ®µ 4: è§£æåŠ¨ä½œ ====================
    try:
        action = parse_action(response.action)
    except ValueError:
        # è§£æå¤±è´¥ â†’ å½“ä½œ finish
        action = finish(message=response.action)
    
    # ==================== é˜¶æ®µ 5: æ‰“å°æ—¥å¿— ====================
    if self.agent_config.verbose:
        print("\n" + "=" * 50)
        print("ğŸ’­ æ€è€ƒè¿‡ç¨‹:")
        print("-" * 50)
        print(response.thinking)
        print("-" * 50)
        print("ğŸ¯ æ‰§è¡ŒåŠ¨ä½œ:")
        print(json.dumps(action, ensure_ascii=False, indent=2))
        print("=" * 50 + "\n")
    
    # ==================== é˜¶æ®µ 6: ä¸Šä¸‹æ–‡ä¼˜åŒ– ====================
    # åˆ é™¤ä¸Šä¸€æ¡æ¶ˆæ¯ä¸­çš„å›¾åƒï¼ˆèŠ‚çœ tokenï¼‰
    self._context[-1] = MessageBuilder.remove_images_from_message(
        self._context[-1]
    )
    
    # ==================== é˜¶æ®µ 7: æ‰§è¡ŒåŠ¨ä½œ ====================
    try:
        result = self.action_handler.execute(
            action, screenshot.width, screenshot.height
        )
    except Exception as e:
        # æ‰§è¡Œå¤±è´¥ â†’ å¼ºåˆ¶ç»“æŸ
        result = self.action_handler.execute(
            finish(message=str(e)), 
            screenshot.width, screenshot.height
        )
    
    # ==================== é˜¶æ®µ 8: æ·»åŠ  AI å“åº”åˆ°å†å² ====================
    self._context.append(
        MessageBuilder.create_assistant_message(
            f"<think>{response.thinking}</think>"
            f"<answer>{response.action}</answer>"
        )
    )
    
    # ==================== é˜¶æ®µ 9: æ£€æŸ¥ç»ˆæ­¢ ====================
    finished = (
        action.get("_metadata") == "finish" or 
        result.should_finish
    )
    
    if finished and self.agent_config.verbose:
        print("\n" + "ğŸ‰ " + "=" * 48)
        print(f"âœ… ä»»åŠ¡å®Œæˆ: {result.message or action.get('message', 'å®Œæˆ')}")
        print("=" * 50 + "\n")
    
    return StepResult(
        success=result.success,
        finished=finished,
        action=action,
        thinking=response.thinking,
        message=result.message or action.get("message"),
    )
```

**ä»£ç ç²¾è¯»è¦ç‚¹**:

1. **9 ä¸ªæ¸…æ™°çš„é˜¶æ®µ**: æ¯ä¸ªé˜¶æ®µèŒè´£æ˜ç¡®
2. **é”™è¯¯å¤„ç†**: æ¨¡å‹å¼‚å¸¸ã€è§£æå¤±è´¥ã€æ‰§è¡Œé”™è¯¯éƒ½æœ‰å®¹é”™
3. **ä¸Šä¸‹æ–‡ä¼˜åŒ–**: åˆ é™¤å†å²å›¾åƒï¼Œæ§åˆ¶ token æ¶ˆè€—
4. **å¯è§‚æµ‹æ€§**: verbose æ¨¡å¼ä¸‹è¾“å‡ºè¯¦ç»†æ—¥å¿—
5. **çŠ¶æ€ç®¡ç†**: å¯¹è¯å†å²å®Œæ•´ä¿ç•™

**å­¦ä¹ ç‚¹**: è¿™æ˜¯ä¸€ä¸ªæ•™ç§‘ä¹¦çº§çš„ Agent ä¸»å¾ªç¯å®ç°ï¼

---

## ğŸ§  æ ¸å¿ƒæ–‡ä»¶ 2: model/client.py

### æ–‡ä»¶èŒè´£
è´Ÿè´£ä¸ OpenAI å…¼å®¹çš„ API äº¤äº’

### å…³é”®ç±»å’Œæ–¹æ³•

#### 1. ModelConfig (é…ç½®ç±»)

```python
@dataclass
class ModelConfig:
    base_url: str = "http://localhost:8000/v1"
    api_key: str = "EMPTY"
    model_name: str = "autoglm-phone-9b"
    max_tokens: int = 3000
    temperature: float = 0.0          # ç¡®å®šæ€§è¾“å‡º
    top_p: float = 0.85
    frequency_penalty: float = 0.2    # å‡å°‘é‡å¤
    extra_body: dict = field(
        default_factory=lambda: {"skip_special_tokens": False}
    )
```

**å‚æ•°è§£è¯»**:
- `temperature=0.0`: è®©è¾“å‡ºæ›´ç¡®å®šï¼Œå‡å°‘éšæœºæ€§
- `frequency_penalty=0.2`: æƒ©ç½šé‡å¤å†…å®¹
- `skip_special_tokens=False`: ä¿ç•™ `<think>` ç­‰ç‰¹æ®Š token

---

#### 2. ModelClient.request() (å‘é€è¯·æ±‚)

```python
def request(self, messages: list[dict[str, Any]]) -> ModelResponse:
    """å‘é€è¯·æ±‚åˆ°æ¨¡å‹"""
    # è°ƒç”¨ OpenAI API
    response = self.client.chat.completions.create(
        messages=messages,
        model=self.config.model_name,
        max_tokens=self.config.max_tokens,
        temperature=self.config.temperature,
        top_p=self.config.top_p,
        frequency_penalty=self.config.frequency_penalty,
        extra_body=self.config.extra_body,
    )
    
    raw_content = response.choices[0].message.content
    
    # è§£æ Think-Answer
    thinking, action = self._parse_response(raw_content)
    
    return ModelResponse(
        thinking=thinking, 
        action=action, 
        raw_content=raw_content
    )
```

**è®¾è®¡äº®ç‚¹**:
- OpenAI æ ‡å‡†æ¥å£: æ˜“äºæ›¿æ¢å…¶ä»–æ¨¡å‹
- è¿”å›ç»“æ„åŒ–æ•°æ®: `ModelResponse` åŒ…å«è§£æåçš„å†…å®¹

---

#### 3. ModelClient._parse_response() (è§£æå“åº”)

```python
def _parse_response(self, content: str) -> tuple[str, str]:
    """è§£ææ¨¡å‹å“åº”"""
    if "<answer>" not in content:
        # æ²¡æœ‰æ ‡å‡†æ ¼å¼ â†’ å…¨éƒ¨å½“ä½œåŠ¨ä½œ
        return "", content
    
    # åˆ†å‰² Think å’Œ Answer
    parts = content.split("<answer>", 1)
    thinking = parts[0].replace("<think>", "").replace("</think>", "").strip()
    action = parts[1].replace("</answer>", "").strip()
    
    return thinking, action
```

**å®¹é”™è®¾è®¡**: å¦‚æœæ¨¡å‹æ²¡æœ‰æŒ‰æ ¼å¼è¾“å‡ºï¼Œä¹Ÿèƒ½æ­£å¸¸å¤„ç†

---

#### 4. MessageBuilder (æ¶ˆæ¯æ„å»ºå™¨)

è¿™æ˜¯ä¸€ä¸ªé™æ€å·¥å…·ç±»ï¼Œæä¾›æ¶ˆæ¯æ„å»ºæ–¹æ³•ï¼š

```python
class MessageBuilder:
    @staticmethod
    def create_system_message(content: str):
        return {"role": "system", "content": content}
    
    @staticmethod
    def create_user_message(text: str, image_base64: str | None = None):
        content = []
        
        if image_base64:
            content.append({
                "type": "image_url",
                "image_url": {
                    "url": f"data:image/png;base64,{image_base64}"
                }
            })
        
        content.append({"type": "text", "text": text})
        
        return {"role": "user", "content": content}
    
    @staticmethod
    def create_assistant_message(content: str):
        return {"role": "assistant", "content": content}
    
    @staticmethod
    def remove_images_from_message(message: dict):
        """åˆ é™¤æ¶ˆæ¯ä¸­çš„å›¾åƒå†…å®¹"""
        if isinstance(message.get("content"), list):
            message["content"] = [
                item for item in message["content"] 
                if item.get("type") == "text"
            ]
        return message
```

**å­¦ä¹ ç‚¹**: 
- é™æ€æ–¹æ³•å°è£…: ä¸éœ€è¦å®ä¾‹åŒ–
- æ ‡å‡†åŒ–æ„å»º: ç¡®ä¿æ¶ˆæ¯æ ¼å¼æ­£ç¡®
- ä¸Šä¸‹æ–‡ä¼˜åŒ–: `remove_images_from_message` èŠ‚çœ token

---

## âš™ï¸ æ ¸å¿ƒæ–‡ä»¶ 3: actions/handler.py

### æ–‡ä»¶èŒè´£
å°† AI çš„å†³ç­–è½¬æ¢ä¸ºå®é™…çš„è®¾å¤‡æ“ä½œ

### å…³é”®ç±»å’Œæ–¹æ³•

#### 1. ActionHandler.execute() (æ‰§è¡ŒåŠ¨ä½œ)

```python
def execute(
    self, action: dict[str, Any], 
    screen_width: int, screen_height: int
) -> ActionResult:
    """æ‰§è¡Œä¸€ä¸ªåŠ¨ä½œ"""
    action_type = action.get("_metadata")
    
    # Finish åŠ¨ä½œ â†’ ä»»åŠ¡å®Œæˆ
    if action_type == "finish":
        return ActionResult(
            success=True, 
            should_finish=True, 
            message=action.get("message")
        )
    
    # å¿…é¡»æ˜¯ "do" ç±»å‹
    if action_type != "do":
        return ActionResult(
            success=False, 
            should_finish=True,
            message=f"Unknown action type: {action_type}"
        )
    
    # è·å–å…·ä½“åŠ¨ä½œåç§°
    action_name = action.get("action")
    handler_method = self._get_handler(action_name)
    
    if handler_method is None:
        return ActionResult(
            success=False, 
            should_finish=False,
            message=f"Unknown action: {action_name}"
        )
    
    # æ‰§è¡ŒåŠ¨ä½œ
    try:
        return handler_method(action, screen_width, screen_height)
    except Exception as e:
        return ActionResult(
            success=False, 
            should_finish=False, 
            message=f"Action failed: {e}"
        )
```

**è®¾è®¡æ¨¡å¼**: **ç­–ç•¥æ¨¡å¼**
- ä¸åŒåŠ¨ä½œæœ‰ä¸åŒçš„å¤„ç†æ–¹æ³•
- é€šè¿‡ `_get_handler()` æŸ¥æ‰¾å¯¹åº”æ–¹æ³•

---

#### 2. ActionHandler._get_handler() (åŠ¨ä½œè·¯ç”±)

```python
def _get_handler(self, action_name: str) -> Callable | None:
    """è·å–åŠ¨ä½œå¤„ç†æ–¹æ³•"""
    handlers = {
        "Launch": self._handle_launch,
        "Tap": self._handle_tap,
        "Type": self._handle_type,
        "Type_Name": self._handle_type,  # å¤ç”¨ Type å¤„ç†
        "Swipe": self._handle_swipe,
        "Back": self._handle_back,
        "Home": self._handle_home,
        "Double Tap": self._handle_double_tap,
        "Long Press": self._handle_long_press,
        "Wait": self._handle_wait,
        "Take_over": self._handle_takeover,
        "Note": self._handle_note,
        "Call_API": self._handle_call_api,
        "Interact": self._handle_interact,
    }
    return handlers.get(action_name)
```

**å­¦ä¹ ç‚¹**: å­—å…¸æ˜ å°„ï¼Œæ˜“äºæ‰©å±•æ–°åŠ¨ä½œ

---

#### 3. åæ ‡è½¬æ¢æ–¹æ³•

```python
def _convert_relative_to_absolute(
    self, element: list[int], 
    screen_width: int, screen_height: int
) -> tuple[int, int]:
    """ç›¸å¯¹åæ ‡ (0-1000) â†’ ç»å¯¹åæ ‡ (åƒç´ )"""
    x = int(element[0] / 1000 * screen_width)
    y = int(element[1] / 1000 * screen_height)
    return x, y
```

**ç¤ºä¾‹**:
```python
# å±å¹•: 1080x2400
# ç›¸å¯¹åæ ‡: [500, 200] (æ°´å¹³ä¸­å¤®ï¼Œé ä¸Š)
# ç»å¯¹åæ ‡: (540, 480)
```

---

#### 4. å…³é”®åŠ¨ä½œå¤„ç†æ–¹æ³•

**Tap (ç‚¹å‡»)**:
```python
def _handle_tap(self, action: dict, width: int, height: int):
    element = action.get("element")
    if not element:
        return ActionResult(False, False, "No element coordinates")
    
    x, y = self._convert_relative_to_absolute(element, width, height)
    
    # æ•æ„Ÿæ“ä½œç¡®è®¤
    if "message" in action:
        if not self.confirmation_callback(action["message"]):
            return ActionResult(
                success=False, 
                should_finish=True,
                message="User cancelled sensitive operation"
            )
    
    tap(x, y, self.device_id)
    return ActionResult(True, False)
```

**Type (è¾“å…¥æ–‡æœ¬)**:
```python
def _handle_type(self, action: dict, width: int, height: int):
    text = action.get("text", "")
    
    # åˆ‡æ¢åˆ° ADB Keyboard
    original_ime = detect_and_set_adb_keyboard(self.device_id)
    time.sleep(1.0)
    
    # æ¸…ç©º + è¾“å…¥
    clear_text(self.device_id)
    time.sleep(1.0)
    type_text(text, self.device_id)
    time.sleep(1.0)
    
    # æ¢å¤åŸè¾“å…¥æ³•
    restore_keyboard(original_ime, self.device_id)
    time.sleep(1.0)
    
    return ActionResult(True, False)
```

**å­¦ä¹ ç‚¹**: è¾“å…¥æ“ä½œéœ€è¦åˆ‡æ¢è¾“å…¥æ³•ï¼Œæµç¨‹è¾ƒå¤æ‚

---

#### 5. parse_action() (åŠ¨ä½œè§£æ)

```python
def parse_action(response: str) -> dict[str, Any]:
    """è§£ææ¨¡å‹è¾“å‡ºçš„åŠ¨ä½œå­—ç¬¦ä¸²"""
    try:
        response = response.strip()
        
        if response.startswith("do"):
            # do(action="Tap", element=[500, 200])
            action = eval(response)  # âš ï¸ ä½¿ç”¨ eval
        elif response.startswith("finish"):
            # finish(message="ä»»åŠ¡å®Œæˆ")
            action = {
                "_metadata": "finish",
                "message": response.replace("finish(message=", "")[1:-2]
            }
        else:
            raise ValueError(f"Failed to parse action: {response}")
        
        return action
    except Exception as e:
        raise ValueError(f"Failed to parse action: {e}")
```

**æ³¨æ„**: ä½¿ç”¨ `eval()` è§£æï¼Œ**å­˜åœ¨å®‰å…¨é£é™©**ï¼
- ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨æ›´å®‰å…¨çš„è§£ææ–¹æ³•ï¼ˆå¦‚ ASTï¼‰
- å½“å‰å‡è®¾æ¨¡å‹è¾“å‡ºå¯ä¿¡

---

## ğŸ”Œ æ ¸å¿ƒæ–‡ä»¶ 4: adb/*.py

### 4.1 device.py (è®¾å¤‡æ§åˆ¶)

**å…³é”®å‡½æ•°**:

```python
def tap(x: int, y: int, device_id: str | None = None, delay: float = 1.0):
    """ç‚¹å‡»"""
    adb_prefix = _get_adb_prefix(device_id)
    subprocess.run(
        adb_prefix + ["shell", "input", "tap", str(x), str(y)],
        capture_output=True
    )
    time.sleep(delay)

def swipe(start_x, start_y, end_x, end_y, duration_ms=None, device_id=None):
    """æ»‘åŠ¨"""
    if duration_ms is None:
        # æ ¹æ®è·ç¦»è‡ªåŠ¨è®¡ç®—æ—¶é•¿
        dist_sq = (start_x - end_x) ** 2 + (start_y - end_y) ** 2
        duration_ms = int(dist_sq / 1000)
        duration_ms = max(1000, min(duration_ms, 2000))  # 1-2 ç§’
    
    subprocess.run(
        adb_prefix + [
            "shell", "input", "swipe",
            str(start_x), str(start_y),
            str(end_x), str(end_y),
            str(duration_ms)
        ],
        capture_output=True
    )
    time.sleep(delay)

def launch_app(app_name: str, device_id: str | None = None):
    """å¯åŠ¨åº”ç”¨"""
    if app_name not in APP_PACKAGES:
        return False
    
    package = APP_PACKAGES[app_name]
    subprocess.run(
        adb_prefix + [
            "shell", "monkey",
            "-p", package,
            "-c", "android.intent.category.LAUNCHER",
            "1"
        ],
        capture_output=True
    )
    time.sleep(delay)
    return True
```

**å­¦ä¹ ç‚¹**: 
- ADB å‘½ä»¤å°è£…ç®€æ´
- è‡ªåŠ¨è®¡ç®—æ»‘åŠ¨æ—¶é•¿ï¼ˆæ ¹æ®è·ç¦»ï¼‰
- ä½¿ç”¨ `monkey` å‘½ä»¤å¯åŠ¨åº”ç”¨

---

### 4.2 screenshot.py (å±å¹•æˆªå›¾)

```python
def get_screenshot(device_id: str | None = None, timeout: int = 10):
    """æˆªå–å±å¹•"""
    temp_path = f"/tmp/screenshot_{uuid.uuid4()}.png"
    adb_prefix = _get_adb_prefix(device_id)
    
    try:
        # 1. æˆªå›¾åˆ°è®¾å¤‡
        result = subprocess.run(
            adb_prefix + ["shell", "screencap", "-p", "/sdcard/tmp.png"],
            capture_output=True, text=True, timeout=timeout
        )
        
        # 2. æ£€æµ‹æ•æ„Ÿé¡µé¢
        output = result.stdout + result.stderr
        if "Status: -1" in output or "Failed" in output:
            return _create_fallback_screenshot(is_sensitive=True)
        
        # 3. æ‹‰å–åˆ°æœ¬åœ°
        subprocess.run(
            adb_prefix + ["pull", "/sdcard/tmp.png", temp_path],
            capture_output=True, text=True, timeout=5
        )
        
        # 4. è¯»å–å¹¶ç¼–ç 
        img = Image.open(temp_path)
        width, height = img.size
        
        buffered = BytesIO()
        img.save(buffered, format="PNG")
        base64_data = base64.b64encode(buffered.getvalue()).decode("utf-8")
        
        os.remove(temp_path)
        
        return Screenshot(
            base64_data=base64_data, 
            width=width, height=height, 
            is_sensitive=False
        )
    
    except Exception as e:
        print(f"Screenshot error: {e}")
        return _create_fallback_screenshot(is_sensitive=False)
```

**å…³é”®ç‚¹**:
- æ•æ„Ÿé¡µé¢æ£€æµ‹: æˆªå›¾å¤±è´¥æ—¶è¿”å›é»‘å±
- æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- é”™è¯¯å®¹é”™

---

### 4.3 connection.py (è¿æ¥ç®¡ç†)

æ”¯æŒè¿œç¨‹è°ƒè¯•çš„æ ¸å¿ƒæ¨¡å—ï¼š

```python
class ADBConnection:
    def connect(self, address: str):
        """è¿æ¥è¿œç¨‹è®¾å¤‡"""
        result = subprocess.run(
            ["adb", "connect", address],
            capture_output=True, text=True
        )
        
        if "connected" in result.stdout:
            return True, f"Connected to {address}"
        else:
            return False, f"Failed to connect: {result.stdout}"
    
    def enable_tcpip(self, port: int = 5555, device_id: str | None = None):
        """åœ¨ USB è®¾å¤‡ä¸Šå¯ç”¨ TCP/IP"""
        adb_prefix = ["adb"] if not device_id else ["adb", "-s", device_id]
        
        result = subprocess.run(
            adb_prefix + ["tcpip", str(port)],
            capture_output=True, text=True
        )
        
        if "restarting" in result.stdout:
            return True, f"TCP/IP enabled on port {port}"
        else:
            return False, f"Failed: {result.stdout}"
```

---

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶ 5: config/prompts.py

### System Prompt ç»“æ„

```python
SYSTEM_PROMPT = """
ä»Šå¤©çš„æ—¥æœŸæ˜¯: 2025å¹´12æœˆ09æ—¥

ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ä½“åˆ†æä¸“å®¶ï¼Œå¯ä»¥æ ¹æ®æ“ä½œå†å²å’Œå½“å‰çŠ¶æ€å›¾æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œæ¥å®Œæˆä»»åŠ¡ã€‚

ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§è¦æ±‚è¾“å‡ºä»¥ä¸‹æ ¼å¼ï¼š
<think>{think}</think>
<answer>{action}</answer>

å…¶ä¸­ï¼š
- {think} æ˜¯å¯¹ä½ ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ“ä½œçš„ç®€çŸ­æ¨ç†è¯´æ˜ã€‚
- {action} æ˜¯æœ¬æ¬¡æ‰§è¡Œçš„å…·ä½“æ“ä½œæŒ‡ä»¤ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªä¸‹æ–¹å®šä¹‰çš„æŒ‡ä»¤æ ¼å¼ã€‚

æ“ä½œæŒ‡ä»¤åŠå…¶ä½œç”¨å¦‚ä¸‹ï¼š
- do(action="Launch", app="xxx")  
    Launchæ˜¯å¯åŠ¨ç›®æ ‡appçš„æ“ä½œ...
- do(action="Tap", element=[x,y])  
    Tapæ˜¯ç‚¹å‡»æ“ä½œ...
...

å¿…é¡»éµå¾ªçš„è§„åˆ™ï¼š
1. åœ¨æ‰§è¡Œä»»ä½•æ“ä½œå‰ï¼Œå…ˆæ£€æŸ¥å½“å‰appæ˜¯å¦æ˜¯ç›®æ ‡app...
2. å¦‚æœè¿›å…¥åˆ°äº†æ— å…³é¡µé¢ï¼Œå…ˆæ‰§è¡Œ Back...
...
18. åœ¨ç»“æŸä»»åŠ¡å‰è¯·ä¸€å®šè¦ä»”ç»†æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæ•´å‡†ç¡®çš„å®Œæˆ...
"""
```

**æç¤ºè¯è®¾è®¡è¦ç‚¹**:
1. **æ˜ç¡®è¾“å‡ºæ ¼å¼**: Think-Answer ç»“æ„
2. **è¯¦ç»†åŠ¨ä½œå®šä¹‰**: æ¯ä¸ªåŠ¨ä½œéƒ½æœ‰è¯´æ˜å’Œç¤ºä¾‹
3. **18 æ¡è¡Œä¸ºè§„åˆ™**: å¼•å¯¼ AI é¿å…å¸¸è§é”™è¯¯
4. **æ³¨å…¥æ—¥æœŸ**: å¸®åŠ© AI ç†è§£æ—¶é—´ç›¸å…³ä»»åŠ¡

---

## ğŸš€ ä¸»ç¨‹åº: main.py

### æ ¸å¿ƒæµç¨‹

```python
def main():
    args = parse_args()
    
    # 1. åˆ—å‡ºåº”ç”¨
    if args.list_apps:
        for app in sorted(list_supported_apps()):
            print(f"  - {app}")
        return
    
    # 2. è®¾å¤‡ç®¡ç†
    if handle_device_commands(args):
        return
    
    # 3. ç³»ç»Ÿæ£€æŸ¥
    if not check_system_requirements():
        sys.exit(1)
    
    # 4. æ¨¡å‹ API æ£€æŸ¥
    if not check_model_api(args.base_url, args.model):
        sys.exit(1)
    
    # 5. åˆ›å»º Agent
    agent = PhoneAgent(
        model_config=ModelConfig(...),
        agent_config=AgentConfig(...)
    )
    
    # 6. æ‰§è¡Œä»»åŠ¡
    if args.task:
        result = agent.run(args.task)
        print(f"\nResult: {result}")
    else:
        # äº¤äº’æ¨¡å¼
        while True:
            task = input("Enter your task: ").strip()
            if task.lower() in ("quit", "exit", "q"):
                break
            result = agent.run(task)
            print(f"\nResult: {result}\n")
            agent.reset()
```

**ç³»ç»Ÿæ£€æŸ¥**:
1. ADB æ˜¯å¦å®‰è£…
2. è®¾å¤‡æ˜¯å¦è¿æ¥
3. ADB Keyboard æ˜¯å¦å®‰è£…
4. æ¨¡å‹ API æ˜¯å¦å¯ç”¨

---

## ğŸ“ ä»£ç å­¦ä¹ è¦ç‚¹æ€»ç»“

### 1. æ¶æ„è®¾è®¡
- âœ… æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†
- âœ… ä¾èµ–æ³¨å…¥æ¨¡å¼
- âœ… ç­–ç•¥æ¨¡å¼ï¼ˆåŠ¨ä½œå¤„ç†ï¼‰

### 2. é”™è¯¯å¤„ç†
- âœ… å¤šå±‚å®¹é”™æœºåˆ¶
- âœ… ä¼˜é›…é™çº§ï¼ˆé»‘å±ã€è§£æå¤±è´¥ï¼‰
- âœ… å¼‚å¸¸æ•è·å®Œæ•´

### 3. å¯æ‰©å±•æ€§
- âœ… æ˜“äºæ·»åŠ æ–°åŠ¨ä½œ
- âœ… é…ç½®å¤–éƒ¨åŒ–
- âœ… å›è°ƒæœºåˆ¶

### 4. å·¥ç¨‹å®è·µ
- âœ… ç±»å‹æ³¨è§£ (Type Hints)
- âœ… æ•°æ®ç±» (Dataclass)
- âœ… æ–‡æ¡£å­—ç¬¦ä¸²å®Œæ•´

### 5. æ€§èƒ½ä¼˜åŒ–
- âœ… ä¸Šä¸‹æ–‡å›¾åƒæ¸…ç†
- âœ… æ­¥æ•°é™åˆ¶
- âœ… è¶…æ—¶æ§åˆ¶

---

## ğŸ“‹ é˜…è¯»æ£€æŸ¥æ¸…å•

å®Œæˆä»£ç é˜…è¯»åï¼Œç¡®è®¤ä½ èƒ½å›ç­”ï¼š

- [ ] `PhoneAgent._execute_step()` çš„ 9 ä¸ªé˜¶æ®µåˆ†åˆ«åšä»€ä¹ˆï¼Ÿ
- [ ] ä¸ºä»€ä¹ˆè¦åˆ é™¤å†å²æ¶ˆæ¯ä¸­çš„å›¾åƒï¼Ÿ
- [ ] åæ ‡è½¬æ¢çš„å…¬å¼æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] `parse_action()` ä½¿ç”¨ `eval()` çš„é£é™©æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] ADB Keyboard å¦‚ä½•è¾“å…¥ä¸­æ–‡ï¼Ÿ
- [ ] ç³»ç»Ÿæç¤ºè¯åŒ…å«å“ªäº›å…³é”®éƒ¨åˆ†ï¼Ÿ
- [ ] å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ–°çš„åŠ¨ä½œç±»å‹ï¼Ÿ
- [ ] è¿œç¨‹è¿æ¥çš„æ ¸å¿ƒå‘½ä»¤æ˜¯ä»€ä¹ˆï¼Ÿ

---

**ä»£ç å³æ–‡æ¡£ï¼Œè¯»æ‡‚ä»£ç æ‰æ˜¯çœŸæ­£çš„ç†è§£ï¼ğŸ“š**



# Open-AutoGLM 项目知识图谱

本文档以可视化的方式呈现项目的核心知识结构，帮助你建立全局认知。

---

## 🗺️ 整体知识结构

```
Open-AutoGLM 项目
│
├─ 基础层 (Foundation)
│  ├─ Android 系统
│  │  ├─ ADB 工具
│  │  ├─ UI 层级
│  │  └─ 输入法系统
│  │
│  ├─ 多模态模型
│  │  ├─ 视觉编码器
│  │  ├─ 语言模型
│  │  └─ 融合机制
│  │
│  └─ Python 生态
│     ├─ Pillow (图像)
│     ├─ OpenAI SDK
│     └─ subprocess
│
├─ 核心层 (Core)
│  ├─ Agent 系统
│  │  ├─ 感知 (Screenshot)
│  │  ├─ 推理 (VLM)
│  │  ├─ 决策 (Think-Answer)
│  │  └─ 执行 (ADB Actions)
│  │
│  ├─ 模型交互
│  │  ├─ 消息构建
│  │  ├─ 上下文管理
│  │  ├─ 响应解析
│  │  └─ 错误处理
│  │
│  └─ 动作系统
│     ├─ 12 种动作类型
│     ├─ 坐标转换
│     ├─ 回调机制
│     └─ 结果反馈
│
├─ 应用层 (Application)
│  ├─ 命令行工具
│  │  ├─ 参数解析
│  │  ├─ 系统检查
│  │  └─ 交互模式
│  │
│  ├─ Python API
│  │  ├─ PhoneAgent 类
│  │  ├─ 配置系统
│  │  └─ 扩展接口
│  │
│  └─ 远程调试
│     ├─ WiFi 连接
│     ├─ 多设备管理
│     └─ 网络优化
│
└─ 优化层 (Optimization)
   ├─ 性能优化
   │  ├─ 上下文清理
   │  ├─ 图像压缩
   │  └─ 响应缓存
   │
   ├─ 鲁棒性
   │  ├─ 多层容错
   │  ├─ 敏感检测
   │  └─ 重试机制
   │
   └─ 可扩展性
      ├─ 插件系统
      ├─ 配置化
      └─ 模块解耦
```

---

## 🔄 数据流图

```
┌─────────────┐
│ 用户输入任务  │
│"打开小红书"  │
└──────┬──────┘
       │
       ▼
┌─────────────────────────┐
│   PhoneAgent.run()      │
│  - 初始化上下文          │
│  - 设置 System Prompt   │
└──────┬──────────────────┘
       │
       ▼ (循环开始)
┌─────────────────────────┐
│ 1. 感知阶段              │
│  - get_screenshot()     │  ┌──────────┐
│  - get_current_app()    │  │  Android │
│                         │──│  Device  │
│  [截图 + 应用名称]       │  └──────────┘
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ 2. 消息构建              │
│  - 添加屏幕截图 (Base64) │
│  - 添加屏幕信息 (JSON)   │
│  - 添加到对话历史        │
│                         │
│  [多模态消息]            │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ 3. 模型推理              │  ┌──────────┐
│  - ModelClient.request()│  │ AutoGLM  │
│  - 发送消息到 VLM       │──│  Model   │
│  - 等待响应             │  └──────────┘
│                         │
│  [Think + Answer]       │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ 4. 响应解析              │
│  - 提取 <think> 内容     │
│  - 提取 <answer> 内容    │
│  - parse_action()       │
│                         │
│  [动作字典]              │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ 5. 上下文优化            │
│  - 删除历史图像          │
│  - 保留文本内容          │
│  - 添加 AI 响应到历史    │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ 6. 动作执行              │
│  - ActionHandler.execute│  ┌──────────┐
│  - 坐标转换             │  │   ADB    │
│  - ADB 命令发送         │──│ Commands │
│                         │  └──────────┘
│  [执行结果]              │
└──────┬──────────────────┘
       │
       ▼
┌─────────────────────────┐
│ 7. 检查终止              │
│  - 是否 finish 动作？    │
│  - 是否达到最大步数？    │
│  - 是否出现错误？        │
└──────┬──────────────────┘
       │
       ├─ 未完成 ──┐
       │           │
       ▼           │
┌──────────┐       │
│ 返回结果  │       │
└──────────┘       │
                   │
                   └─ 返回到"1. 感知阶段"
```

---

## 🧩 核心组件关系图

```
┌────────────────────────────────────────────────────┐
│                   PhoneAgent                       │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────┐ │
│  │ ModelClient  │  │ActionHandler │  │  Config │ │
│  └──────┬───────┘  └──────┬───────┘  └────┬────┘ │
│         │                 │                │      │
└─────────┼─────────────────┼────────────────┼──────┘
          │                 │                │
          │                 │                │
    ┌─────▼─────┐     ┌─────▼─────┐    ┌────▼────┐
    │   Model   │     │  Actions  │    │  ADB    │
    │   API     │     │  Module   │    │ Module  │
    └─────┬─────┘     └─────┬─────┘    └────┬────┘
          │                 │                │
    ┌─────▼─────┐     ┌─────▼─────┐    ┌────▼────┐
    │ OpenAI    │     │ do()      │    │device.py│
    │ Client    │     │ finish()  │    │input.py │
    │           │     │ parse()   │    │screen.py│
    └───────────┘     └───────────┘    └─────────┘
```

---

## 💡 核心概念图

### 1. Think-Answer 模式

```
┌─────────────────────────────────────────────┐
│           AI 模型的输出格式                   │
├─────────────────────────────────────────────┤
│                                             │
│  <think>                                    │
│    推理过程：                                │
│    1. 观察当前状态                           │
│    2. 分析任务需求                           │
│    3. 规划下一步动作                         │
│    4. 考虑可能的问题                         │
│  </think>                                   │
│                                             │
│  <answer>                                   │
│    do(                                      │
│      action="Tap",                          │
│      element=[500, 200]                     │
│    )                                        │
│  </answer>                                  │
│                                             │
└─────────────────────────────────────────────┘
         │                    │
         │                    │
    ┌────▼────┐          ┌────▼────┐
    │  可解释  │          │  可执行  │
    │  透明化  │          │  结构化  │
    └─────────┘          └─────────┘
```

### 2. 坐标转换机制

```
┌───────────────────────────────────────────────┐
│        虚拟坐标系 (0-1000)                      │
│  ┌──────────────────────────────────────┐    │
│  │ (0,0)                      (1000,0)  │    │
│  │                                      │    │
│  │                                      │    │
│  │           (500,500) ●                │    │
│  │            中心点                     │    │
│  │                                      │    │
│  │                                      │    │
│  │ (0,1000)                  (1000,1000)│    │
│  └──────────────────────────────────────┘    │
└───────────────┬───────────────────────────────┘
                │ 转换公式
                │ x_pixel = x_rel / 1000 * width
                │ y_pixel = y_rel / 1000 * height
                ▼
┌───────────────────────────────────────────────┐
│      实际屏幕 (1080x2400)                      │
│  ┌──────────────────────────────────────┐    │
│  │ (0,0)                      (1080,0)  │    │
│  │                                      │    │
│  │                                      │    │
│  │                                      │    │
│  │           (540,1200) ●               │    │
│  │            中心点                     │    │
│  │                                      │    │
│  │                                      │    │
│  │                                      │    │
│  │ (0,2400)                  (1080,2400)│    │
│  └──────────────────────────────────────┘    │
└───────────────────────────────────────────────┘
```

### 3. 上下文管理策略

```
Step 1:
┌─────────────────────────────────┐
│ [System] 系统提示词              │
│ [User] 任务 + 🖼️ 图像1           │
└─────────────────────────────────┘
  Token: ~2000

Step 2:
┌─────────────────────────────────┐
│ [System] 系统提示词              │
│ [User] 任务 + 🖼️ 图像1           │  ← 删除图像
│ [Assistant] Think + Answer      │
│ [User] 屏幕信息 + 🖼️ 图像2       │
└─────────────────────────────────┘
  Token: ~3500

Step 3:
┌─────────────────────────────────┐
│ [System] 系统提示词              │
│ [User] 任务 + ❌ (图像已删除)     │
│ [Assistant] Think + Answer      │
│ [User] 屏幕信息 + ❌ (图像已删除) │  ← 删除图像
│ [Assistant] Think + Answer      │
│ [User] 屏幕信息 + 🖼️ 图像3       │
└─────────────────────────────────┘
  Token: ~3500 (稳定!)

核心思想：只保留最新的一张图像
效果：Token 数量线性增长而非指数增长
```

---

## 🎯 关键技术栈图

```
┌────────────────────────────────────────────┐
│            应用层                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │ 命令行工具│  │ Python API│  │  示例代码 ││
│  └──────────┘  └──────────┘  └──────────┘│
└─────────────────┬──────────────────────────┘
                  │
┌─────────────────┴──────────────────────────┐
│            Agent 层                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │PhoneAgent│  │ 状态管理  │  │  回调系统 ││
│  └──────────┘  └──────────┘  └──────────┘│
└─────────────────┬──────────────────────────┘
                  │
┌─────────────────┴──────────────────────────┐
│            模型层                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │VLM Client│  │消息构建器 │  │  解析器   ││
│  └──────────┘  └──────────┘  └──────────┘│
└─────────────────┬──────────────────────────┘
                  │
┌─────────────────┴──────────────────────────┐
│            执行层                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │动作处理器│  │ 坐标转换  │  │  容错机制 ││
│  └──────────┘  └──────────┘  └──────────┘│
└─────────────────┬──────────────────────────┘
                  │
┌─────────────────┴──────────────────────────┐
│            设备层                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐│
│  │ADB 控制  │  │  截图     │  │  输入法   ││
│  └──────────┘  └──────────┘  └──────────┘│
└────────────────────────────────────────────┘
```

---

## 📊 性能优化图

```
优化前:
Step 1: 2000 tokens  ──→  模型推理 3s
Step 2: 4000 tokens  ──→  模型推理 5s
Step 3: 6000 tokens  ──→  模型推理 7s
Step 4: 8000 tokens  ──→  模型推理 9s
Step 5: 10000 tokens ──→  模型推理 11s
                           总计: 35s

优化后 (图像清理):
Step 1: 2000 tokens  ──→  模型推理 3s
Step 2: 3500 tokens  ──→  模型推理 4s
Step 3: 3500 tokens  ──→  模型推理 4s
Step 4: 3500 tokens  ──→  模型推理 4s
Step 5: 3500 tokens  ──→  模型推理 4s
                           总计: 19s

提速: 46%
```

---

## 🛡️ 容错机制层次图

```
┌────────────────────────────────────────┐
│  第 1 层: 用户层容错                    │
│  - 敏感操作确认                        │
│  - 人工接管请求                        │
│  - 任务中断与恢复                      │
└─────────────────┬──────────────────────┘
                  │
┌─────────────────▼──────────────────────┐
│  第 2 层: Agent 层容错                  │
│  - 最大步数限制                        │
│  - 模型异常捕获                        │
│  - 响应解析容错                        │
└─────────────────┬──────────────────────┘
                  │
┌─────────────────▼──────────────────────┐
│  第 3 层: 动作层容错                    │
│  - 动作执行异常处理                    │
│  - 坐标越界检查                        │
│  - 重试机制                            │
└─────────────────┬──────────────────────┘
                  │
┌─────────────────▼──────────────────────┐
│  第 4 层: 设备层容错                    │
│  - 敏感页面检测 (黑屏)                 │
│  - ADB 连接检查                        │
│  - 超时控制                            │
└────────────────────────────────────────┘

每一层独立容错，上层失败不影响下层
```

---

## 🔄 改进路径图

```
当前系统
    │
    ├─ 初级改进 (1-3天)
    │   ├─ 添加新动作 ───→ 扩展能力
    │   ├─ 增加应用 ─────→ 覆盖面
    │   ├─ 优化日志 ─────→ 可观测性
    │   └─ 任务历史 ─────→ 可追溯性
    │
    ├─ 中级改进 (3-7天)
    │   ├─ UIAutomator ──→ 精确控制
    │   ├─ 智能重试 ─────→ 鲁棒性
    │   ├─ OCR 集成 ─────→ 文本识别
    │   └─ 任务恢复 ─────→ 可靠性
    │
    └─ 高级改进 (7-14天)
        ├─ 并发执行 ─────→ 效率提升
        ├─ 学习系统 ─────→ 持续优化
        ├─ 模型集成 ─────→ 能力增强
        └─ 自动测试 ─────→ 质量保证
```

---

## 🎓 学习重点分布图

```
          重要性
            ▲
            │
        ⭐⭐⭐│   ● Agent 主循环
            │   ● Think-Answer
            │   ● 归一化坐标
            │   ● 上下文管理
            │   ● 提示词工程
            │
        ⭐⭐ │       ● 多模态消息
            │       ● 动作执行
            │       ● 错误容错
            │       ● ADB 封装
            │
        ⭐  │           ● 远程调试
            │           ● 配置系统
            │           ● 日志系统
            │
            └────────────────────→ 难度
            简单        中等        困难
```

---

## 🌟 技能树

```
Open-AutoGLM 技能树

Level 1: 新手 (1-2天)
├─ ✓ 环境搭建
├─ ✓ 运行示例
├─ ✓ 理解基本概念
└─ ✓ 修改配置

Level 2: 入门 (3-5天)
├─ ✓ 阅读核心代码
├─ ✓ 理解工作原理
├─ ✓ 修改提示词
└─ ✓ 添加新应用

Level 3: 进阶 (7-10天)
├─ ✓ 添加新动作
├─ ✓ 集成 UIAutomator
├─ ✓ 实现智能重试
└─ ✓ 性能优化

Level 4: 高级 (14-21天)
├─ ✓ 并发执行
├─ ✓ 学习系统
├─ ✓ 模型集成
└─ ✓ 架构设计

Level 5: 专家 (30天+)
├─ ✓ 论文发表
├─ ✓ 开源贡献
├─ ✓ 新系统设计
└─ ✓ 技术分享
```

---

## 📚 知识依赖图

```
                  ┌─────────────┐
                  │Open-AutoGLM │
                  └──────┬──────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
    ┌────▼────┐    ┌─────▼─────┐   ┌────▼────┐
    │ Python  │    │ 多模态AI   │   │ Android │
    │ 基础    │    │ 基础       │   │ 基础    │
    └────┬────┘    └─────┬─────┘   └────┬────┘
         │               │               │
    ┌────▼────┐    ┌─────▼─────┐   ┌────▼────┐
    │OOP      │    │VLM        │   │ADB      │
    │异步编程 │    │CoT        │   │UI系统   │
    │错误处理 │    │Prompt Eng │   │输入法   │
    └─────────┘    └───────────┘   └─────────┘

推荐学习顺序:
1. Python 基础 → OOP + 错误处理
2. Android 基础 → ADB + UI 系统
3. 多模态 AI → VLM + Prompt Engineering
4. 整合学习 → Open-AutoGLM
```

---

## 🎯 核心文件重要性图

```
重要性: ⭐⭐⭐ 必读  ⭐⭐ 重要  ⭐ 了解即可

phone_agent/
├─ agent.py              ⭐⭐⭐ (Agent 核心)
├─ model/
│  └─ client.py          ⭐⭐⭐ (模型交互)
├─ actions/
│  └─ handler.py         ⭐⭐⭐ (动作执行)
├─ adb/
│  ├─ device.py          ⭐⭐  (设备控制)
│  ├─ screenshot.py      ⭐⭐  (截图)
│  ├─ input.py           ⭐   (输入)
│  └─ connection.py      ⭐   (连接管理)
└─ config/
   ├─ prompts.py         ⭐⭐⭐ (提示词)
   └─ apps.py            ⭐   (应用映射)

main.py                  ⭐⭐  (命令行工具)
examples/basic_usage.py  ⭐⭐  (使用示例)
```

---

## 🔄 学习循环

```
┌─────────────┐
│  阅读文档    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  理解原理    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  阅读代码    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  动手实践    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  遇到问题    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  深入研究    │  ───┐
└──────┬──────┘     │
       │            │
       ▼            │
┌─────────────┐     │
│  掌握知识    │     │
└──────┬──────┘     │
       │            │
       ▼            │
┌─────────────┐     │
│  分享总结    │     │
└──────┬──────┘     │
       │            │
       └────────────┘
    (提升到更高层次)
```

---

## 💡 关键洞察

### 1. 为什么这个系统能工作？

```
多模态模型的视觉理解能力
        +
归一化坐标的泛化设计
        +
提示词的行为引导
        +
闭环反馈的自我纠错
        ↓
    可用的 Agent 系统
```

### 2. 系统的核心竞争力

```
1. 跨设备泛化 (归一化坐标)
2. 可解释性 (Think-Answer)
3. 鲁棒性 (多层容错)
4. 可扩展性 (模块化设计)
5. 工程化 (完整的工具链)
```

### 3. 值得深入研究的点

```
- Think-Answer 如何提高推理准确性？
- 归一化坐标对模型训练的影响？
- 上下文管理策略的效果评估？
- 提示词规则的优化方法？
- 错误累积的检测与恢复？
```

---

## 🚀 从学习到应用

```
学习阶段
    │
    ├─ 理解原理 ──→ 知其然，知其所以然
    │
    ├─ 掌握技术 ──→ 能读、能写、能改
    │
    └─ 实践改进 ──→ 动手优化系统

应用阶段
    │
    ├─ 简单应用 ──→ 自动化日常任务
    │
    ├─ 项目开发 ──→ 构建实际产品
    │
    └─ 研究创新 ──→ 探索新方向

贡献阶段
    │
    ├─ 开源贡献 ──→ 提交 PR 改进项目
    │
    ├─ 技术分享 ──→ 写博客、做演讲
    │
    └─ 论文发表 ──→ 学术研究成果
```

---

## 📖 总结

这个知识图谱展示了 Open-AutoGLM 项目的全貌：

1. **整体结构**: 从基础层到应用层的完整架构
2. **核心流程**: 从输入到输出的数据流动
3. **关键技术**: Think-Answer、归一化坐标、上下文管理
4. **改进路径**: 从初级到高级的成长路线
5. **学习方法**: 循序渐进的技能树

**建议**:
- 打印这个知识图谱，作为学习地图
- 在学习过程中不断回顾，建立全局认知
- 结合其他文档深入学习每个模块

---

**现在，你已经有了完整的知识地图，开始你的学习之旅吧！🗺️**


